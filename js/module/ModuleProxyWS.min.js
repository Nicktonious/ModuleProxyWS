class ProxyWS{constructor(_wss){this._WSS=_wss,this._Queue=[],this.name="ProxyWS",this._SubID={},Object.on("repl-sub",(id,key)=>{this._WSS.clients.filter(client=>client.key.hashed===key).forEach(client=>{client.RegServices.includes("repl")||client.RegServices.push("Repl")}),this._SubID[id]||(this._SubID[id]=key)}),Object.on("sensor-sub",(id,key)=>{this._WSS.clients.filter(client=>client.key.hashed===key).forEach(client=>{client.RegServices.includes("sensor")||client.RegServices.push("Sensor")}),this._SubID[id]||(this._SubID[id]=key)}),Object.on("process-sub",(id,key)=>{this._WSS.clients.filter(client=>client.key.hashed===key).forEach(client=>{client.RegServices.includes("process")||client.RegServices.push("Process")}),this._SubID[id]||(this._SubID[id]=key)}),Object.on("repl-read",msg=>{this.Send(msg)}),Object.on("sensor-read",msg=>{this.Send(msg)}),Object.on("process-read",msg=>{})}Receive(_data,_key){let obj=null;try{obj=JSON.parse(_data)}catch(e){throw new err("Incorrect JSON data")}let key=_key,meta_crc=obj.MetaData.CRC,actual_crc;if(delete obj.MetaData.CRC,E.CRC32(JSON.stringify(obj))===meta_crc){let flag=!0;obj.MetaData.Command.forEach(comObj=>{flag&&(comObj.com.endsWith("sub")||comObj.com.endsWith("cm")?(Object.emit(comObj.com,obj.MetaData.ID,key),flag=!1):Object.emit(comObj.com,comObj.arg,obj.MetaData.ID))})}}Send(msg){let data=this.FormPackREPL(msg);data.MetaData.CRC=E.CRC32(JSON.stringify(data)),this._WSS.Notify(data)}RemoveSub(key){for(let k of this._SubID)this._SubID[k]===key&&delete this._SubID[k];0===Object.keys(this._SubID).length&&Object.emit("repl-cm","EWI")}FormPackREPL(msg){return{MetaData:{Type:"controller",ID:process.env.SERIAL,TimeStamp2:getTime(),Repl:{com:""},RegServices:"Repl"},Value:msg}}FormPackSensor(msg){return{MetaData:{Type:"controller",ID:process.env.SERIAL,TimeStamp2:getTime(),RegServices:"Sensor",Sensor:{ID:"54-54",Name:"Vova",Type:"meas",TypeOutSignal:"analog",TypeInSignal:"analog",NumPortsRequired:[1],NumChannel:1,Bus:["i2c"]}},Value:msg}}}exports=ProxyWS;